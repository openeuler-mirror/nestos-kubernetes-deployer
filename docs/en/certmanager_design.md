

## Cert Manager

NKD uses Kubeadm to install the Kubernetes cluster. By default, the PKI certificate required by Kubernetes is generated by Kubeadm. This approach will bring many security risks. Kubeadm provides an external CA mode to support user-defined PKI certificates. In order to ensure communication security, NKD uses the certificate management module and follows the Kubernetes best practices[PKI certificates and requirements](https://kubernetes.io/zh-cn/docs/setup/best-practices/certificates/)to generate all certificates.



### CA certificate introduction

| Path                   | Default CN                   | description                   |
| ---------------------- | ------------------------- | ---------------------- |
| ca.crt,key             | kubernetes-ca             | Kubernetes general CA     |
| etcd/ca.crt,key        | etcd-ca                   | For all etcd-related functions |
| front-proxy-ca.crt,key | kubernetes-front-proxy-ca | For the front-end proxy           |

NKD supports customizing the CA certificate in the [certasset] field of the configuration file. If the user does not provide it, NKD will automatically generate the required CA certificate.

### All certificates are as follows

| Default CN                       | recommended key path               | recommended cert path               |
| ----------------------------- | ---------------------------- | ---------------------------- |
| etcd-ca                       | etcd/ca.key                  | etcd/ca.crt                  |
| kube-apiserver-etcd-client    | apiserver-etcd-client.key    | apiserver-etcd-client.crt    |
| kubernetes-ca                 | ca.key                       | ca.crt                       |
| kubernetes-ca                 | ca.key                       | ca.crt                       |
| kube-apiserver                | apiserver.key                | apiserver.crt                |
| kube-apiserver-kubelet-client | apiserver-kubelet-client.key | apiserver-kubelet-client.crt |
| front-proxy-ca                | front-proxy-ca.key           | front-proxy-ca.crt           |
| front-proxy-ca                | front-proxy-ca.key           | front-proxy-ca.crt           |
| front-proxy-client            | front-proxy-client.key       | front-proxy-client.crt       |
| etcd-ca                       | etcd/ca.key                  | etcd/ca.crt                  |
| kube-etcd                     | etcd/server.key              | etcd/server.crt              |
| kube-etcd-peer                | etcd/peer.key                | etcd/peer.crt                |
| etcd-ca                       |                              | etcd/ca.crt                  |
| kube-etcd-healthcheck-client  | etcd/healthcheck-client.key  | etcd/healthcheck-client.crt  |

Same considerations apply for the service account key pair:

| private key path | public key path |
| -------- | -------- |
| sa.key   |          |
|          | sa.pub   |

The file paths you need to provide when generating all keys and certificates yourself are provided below.

```console
/etc/kubernetes/pki/etcd/ca.key
/etc/kubernetes/pki/etcd/ca.crt
/etc/kubernetes/pki/apiserver-etcd-client.key
/etc/kubernetes/pki/apiserver-etcd-client.crt
/etc/kubernetes/pki/ca.key
/etc/kubernetes/pki/ca.crt
/etc/kubernetes/pki/apiserver.key
/etc/kubernetes/pki/apiserver.crt
/etc/kubernetes/pki/apiserver-kubelet-client.key
/etc/kubernetes/pki/apiserver-kubelet-client.crt
/etc/kubernetes/pki/front-proxy-ca.key
/etc/kubernetes/pki/front-proxy-ca.crt
/etc/kubernetes/pki/front-proxy-client.key
/etc/kubernetes/pki/front-proxy-client.crt
/etc/kubernetes/pki/etcd/server.key
/etc/kubernetes/pki/etcd/server.crt
/etc/kubernetes/pki/etcd/peer.key
/etc/kubernetes/pki/etcd/peer.crt
/etc/kubernetes/pki/etcd/healthcheck-client.key
/etc/kubernetes/pki/etcd/healthcheck-client.crt
/etc/kubernetes/pki/sa.key
/etc/kubernetes/pki/sa.pub
```

### KubeConfig

| Filename                  | command               | comment                                                              |
| ----------------------- | ----------------------- | -------------------------------------------------------------------- |
| admin.conf              | kubectl                 | Configures administrator user for the cluster                        |
| kubelet.conf            | kubelet                 | One required for each node in the cluster                            |
| controller-manager.conf | kube-controller-manager | Must be added to manifests in`manifests/kube-controller-manager.yaml`|
| scheduler.conf          | kube-scheduler          | Must be added to manifests in `manifests/kube-scheduler.yaml`        |

Here are the full paths to the files listed in the previous table:

```console
/etc/kubernetes/admin.conf
/etc/kubernetes/kubelet.conf
/etc/kubernetes/controller-manager.conf
/etc/kubernetes/scheduler.conf
```

